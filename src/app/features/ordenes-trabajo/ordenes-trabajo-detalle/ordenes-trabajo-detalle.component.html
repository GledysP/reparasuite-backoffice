<div class="rs-page-container" *ngIf="ot">
  <div class="rs-header-compact">
    <div class="breadcrumb">Work Orders / <span class="current">{{ ot.codigo }}</span></div>
    <div class="header-main-row">
      <div class="title-group">
        <h1>{{ ot.codigo }}</h1>
        <span class="badge-status">{{ ot.estado }}</span>
      </div>
      <button mat-stroked-button routerLink="/ordenes-trabajo" class="btn-back">Volver</button>
    </div>
  </div>

  <div class="rs-grid">
    <div class="col-main">
      <div class="white-card">
        <h2 class="card-label">Summary</h2>
        <div class="summary-flex-compact">
          <div class="data-item"><label>Type</label><p>{{ ot.tipo }}</p></div>
          <div class="data-item"><label>Created</label><p>{{ (ot.creadoEn || ot.createdAt) | date:'yyyy-MM-dd' }}</p></div>
          <div class="data-item"><label>Technician</label><p>{{ ot.tecnico?.nombre || 'Sin asignar' }}</p></div>
          <div class="data-item"><label>Scheduled</label><p>{{ ot.fechaPrevista | date:'yyyy-MM-dd HH:mm' }}</p></div>
        </div>

        <div class="action-section">
          <label class="inner-label">Change Status</label>
          <div class="input-inline-group">
            <mat-form-field appearance="outline" class="ultra-compact-field fit-content">
              <mat-select [formControl]="formEstado.controls.a">
                <mat-option *ngFor="let e of estados" [value]="e">{{ e }}</mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-flat-button class="btn-teal-action" (click)="cambiarEstado()">Update Status</button>
          </div>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">Issue Description</h2>
        <p class="text-body-small">{{ ot.descripcion || 'No description provided.' }}</p>
      </div>

      <div class="white-card">
        <h2 class="card-label">Internal Notes</h2>
        <div class="notes-stack">
          <div class="note-box" *ngFor="let n of ot.notas">
            <div class="note-header">
              <strong>{{ n.autor?.nombre || 'TÃ©cnico' }}</strong> <span>{{ n.creadoEn | date:'MMM d, h:mm a' }}</span>
            </div>
            <p>{{ n.contenido }}</p>
          </div>
          
          <div class="input-inline-group">
            <mat-form-field appearance="outline" class="ultra-compact-field short-note-input">
              <input matInput placeholder="Add a note..." [formControl]="formNota.controls.contenido" (keyup.enter)="anadirNota()" />
            </mat-form-field>
            <button mat-flat-button class="btn-teal-action" (click)="anadirNota()">
              <mat-icon>add</mat-icon> Add
            </button>
          </div>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">Photos</h2>
        <div class="photos-minimal">
          <div class="photo-thumb-container" *ngIf="ot.fotos?.length; else noPhotos">
            <div class="thumb-wrapper" *ngFor="let f of ot.fotos; let i = index" (click)="verFoto(f)">
              <img [src]="f.url || f" class="mini-thumb" alt="Photo">
              <span class="thumb-label" style="font-size: 10px; display: block; text-align: center;">Photo {{i+1}}</span>
            </div>
          </div>
          <ng-template #noPhotos><span class="text-muted">No photos uploaded.</span></ng-template>
          
          <label class="upload-link-btn">
            <input type="file" (change)="onFileSelected($event)" hidden />
            <mat-icon>add_a_photo</mat-icon> Upload Photo
          </label>
        </div>
      </div>
    </div>

    <div class="col-side">
      <div class="white-card">
        <h2 class="card-label">Customer</h2>
        <div class="sidebar-data">
          <div class="name-bold">{{ ot.cliente?.nombre }}</div>
          <div class="row-icon">
            <mat-icon>phone</mat-icon> <span>{{ ot.cliente?.telefono }}</span>
            <mat-icon class="copy-btn-mini" (click)="copyToClipboard(ot.cliente?.telefono)">content_copy</mat-icon>
          </div>
          <div class="row-icon">
            <mat-icon>email</mat-icon> <span>{{ ot.cliente?.email }}</span>
            <mat-icon class="copy-btn-mini" (click)="copyToClipboard(ot.cliente?.email)">content_copy</mat-icon>
          </div>
          <a class="blue-link" [routerLink]="['/clientes', ot.cliente?.id]">Open customer profile</a>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">On-site Visit</h2>
        <div class="sidebar-data">
          <div class="visit-time">Scheduled: {{ ot.fechaPrevista | date:'yyyy-MM-dd h:mm a' }}</div>
          <div class="address-row">
            <mat-icon>location_on</mat-icon>
            <span>{{ ot.direccion || '123 Main Street, Springfield' }}</span>
          </div>
          <button mat-button class="btn-text-icon" (click)="copyToClipboard(ot.direccion)">
            <mat-icon>content_copy</mat-icon> Copy address
          </button>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">Timeline</h2>
        <div class="timeline-compact">
          <div class="tl-node">
            <div class="tl-txt">Work order created</div>
            <div class="tl-date">{{ (ot.creadoEn || ot.createdAt) | date:'yyyy-MM-dd h:mm a' }}</div>
          </div>
        </div>
      </div>

      <button mat-stroked-button class="btn-close-ot interactive-close" (click)="cambiarEstado('CERRADA')">Close Work Order</button>
    </div>
  </div>
</div>

<ng-template #imageModal>
  <div class="modal-small-container">
    <div class="modal-header-mini">
      <span>Photo Preview</span>
      <button mat-icon-button mat-dialog-close><mat-icon>close</mat-icon></button>
    </div>
    <div class="modal-body-mini">
      <img [src]="selectedImageUrl" class="img-contained">
    </div>
  </div>
</ng-template>