<div class="rs-page-container" *ngIf="ot">
  <div class="rs-header-compact">
    <div class="breadcrumb">Órdenes de trabajo / <span class="current">{{ ot.codigo }}</span></div>

    <div class="header-main-row">
      <div class="title-group">
        <h1>{{ ot.codigo }}</h1>
        <span class="badge-status" [attr.data-estado]="ot.estado">{{ ot.estado }}</span>
      </div>

      <button mat-stroked-button routerLink="/ordenes-trabajo" class="btn-back">Volver</button>
    </div>
  </div>

  <div class="rs-grid">
    <div class="col-main">
      <div class="white-card">
        <h2 class="card-label">Resumen</h2>

        <div class="summary-grid">
          <div class="data-item"><label>Tipo</label><p>{{ ot.tipo }}</p></div>
          <div class="data-item"><label>Creada</label><p>{{ (ot.creadoEn || ot.createdAt) | date:'yyyy-MM-dd' }}</p></div>
          <div class="data-item"><label>Técnico</label><p>{{ ot.tecnico?.nombre || 'Sin asignar' }}</p></div>
          <div class="data-item"><label>Programada</label><p>{{ ot.fechaPrevista | date:'yyyy-MM-dd HH:mm' }}</p></div>
        </div>

        <div class="action-section">
          <label class="inner-label">Cambiar estado</label>

          <div class="input-inline-group">
            <mat-form-field appearance="outline" class="ultra-compact-field field-grow">
              <mat-select [formControl]="formEstado.controls.a">
                <mat-option *ngFor="let e of estados" [value]="e">{{ e }}</mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-flat-button class="btn-teal-action btn-fixed" (click)="cambiarEstado()">
              Actualizar
            </button>
          </div>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">Descripción del problema</h2>
        <p class="text-body-small">{{ ot.descripcion || 'No hay descripción.' }}</p>
      </div>

      <div class="white-card">
        <h2 class="card-label">Notas internas</h2>

        <div class="notes-stack">
          <div class="note-box" *ngFor="let n of ot.notas">
            <div class="note-header">
              <strong>{{ n.autor?.nombre || 'Técnico' }}</strong>
              <span>{{ n.creadoEn | date:'MMM d, h:mm a' }}</span>
            </div>
            <p>{{ n.contenido }}</p>
          </div>

          <div class="input-inline-group">
            <mat-form-field appearance="outline" class="ultra-compact-field field-grow">
              <input
                matInput
                placeholder="Agregar nota..."
                [formControl]="formNota.controls.contenido"
                (keyup.enter)="anadirNota()" />
            </mat-form-field>

            <button mat-flat-button class="btn-teal-action btn-fixed" (click)="anadirNota()">
              <mat-icon>add</mat-icon> Agregar
            </button>
          </div>
        </div>
      </div>

      <div class="white-card">
        <h2 class="card-label">Fotos</h2>

        <div class="photos-minimal">
          <div class="photo-thumb-container" *ngIf="ot.fotos?.length; else noPhotos">
            <div class="thumb-wrapper" *ngFor="let f of ot.fotos; let i = index" (click)="verFoto(f)">
              <img [src]="f.url || f" class="mini-thumb" alt="Foto">
              <span class="thumb-label">Foto {{ i + 1 }}</span>
            </div>
          </div>

          <ng-template #noPhotos>
            <span class="text-muted">Sin fotos.</span>
          </ng-template>

          <label class="upload-link-btn">
            <input type="file" (change)="onFileSelected($event)" hidden />
            <mat-icon>add_a_photo</mat-icon> Subir foto
          </label>
        </div>
      </div>
    </div>

    <div class="col-side">
      <div class="white-card side-card">
        <h2 class="card-label">Cliente</h2>

        <div class="sidebar-data">
          <div class="name-bold">{{ ot.cliente?.nombre }}</div>

          <div class="row-icon">
            <mat-icon>phone</mat-icon>
            <span class="truncate">{{ ot.cliente?.telefono }}</span>
            <mat-icon class="copy-btn-mini" (click)="copyToClipboard(ot.cliente?.telefono)">content_copy</mat-icon>
          </div>

          <div class="row-icon">
            <mat-icon>email</mat-icon>
            <span class="truncate">{{ ot.cliente?.email }}</span>
            <mat-icon class="copy-btn-mini" (click)="copyToClipboard(ot.cliente?.email)">content_copy</mat-icon>
          </div>

          <a class="blue-link" [routerLink]="['/clientes', ot.cliente?.id]">Abrir perfil del cliente</a>
        </div>
      </div>

      <div class="white-card side-card">
        <h2 class="card-label">Visita a domicilio</h2>

        <div class="sidebar-data">
          <div class="visit-time">Programada: {{ ot.fechaPrevista | date:'yyyy-MM-dd h:mm a' }}</div>

          <div class="address-row">
            <mat-icon>location_on</mat-icon>
            <span class="truncate">{{ ot.direccion || 'Sin dirección' }}</span>
          </div>

          <button mat-button class="btn-text-icon" (click)="copyToClipboard(ot.direccion)">
            <mat-icon>content_copy</mat-icon> Copiar dirección
          </button>
        </div>
      </div>

      <div class="white-card side-card">
        <h2 class="card-label">Timeline</h2>

        <div class="timeline-compact">
          <div class="tl-node">
            <div class="tl-txt">Orden creada</div>
            <div class="tl-date">{{ (ot.creadoEn || ot.createdAt) | date:'yyyy-MM-dd h:mm a' }}</div>
          </div>
        </div>
      </div>

      <button mat-stroked-button class="btn-close-ot interactive-close" (click)="cambiarEstado('CERRADA')">
        Cerrar orden de trabajo
      </button>
    </div>
  </div>
</div>

<ng-template #imageModal>
  <div class="modal-small-container">
    <div class="modal-header-mini">
      <span>Vista previa</span>
      <button mat-icon-button mat-dialog-close><mat-icon>close</mat-icon></button>
    </div>
    <div class="modal-body-mini">
      <img [src]="selectedImageUrl" class="img-contained">
    </div>
  </div>
</ng-template>
